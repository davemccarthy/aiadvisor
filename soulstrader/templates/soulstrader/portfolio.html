{% extends 'soulstrader/base.html' %}

{% block title %}Portfolio - SOULTRADER{% endblock %}

{% block content %}
<div class="card">
    <h1 style="color: #667eea; margin-bottom: 1rem;">💼 Portfolio Overview</h1>
    <p style="color: #6c757d; margin-bottom: 2rem;">Detailed view of your holdings and portfolio performance.</p>
    
    <!-- Portfolio Summary -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">${{ portfolio.total_value|floatformat:2 }}</div>
            <div class="stat-label">Total Portfolio Value</div>
        </div>
        <div class="stat-card">
            <div class="stat-number {% if portfolio.total_return >= 0 %}positive{% else %}negative{% endif %}">
                {{ portfolio.total_return|floatformat:2 }}%
            </div>
            <div class="stat-label">Total Return</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${{ portfolio.current_capital|floatformat:2 }}</div>
            <div class="stat-label">Available Cash</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${{ total_invested|floatformat:2 }}</div>
            <div class="stat-label">Total Invested</div>
        </div>
    </div>
</div>

<!-- Holdings Table -->
{% if holdings %}
<div class="card">
    <h2 style="margin-bottom: 1.5rem; color: #333;">Your Holdings</h2>
    <div class="table">
        <table>
            <thead>
                <tr>
                    <th style="width: 50px;"></th>
                    <th>Stock</th>
                    <th>Grade</th>
                    <th>Quantity</th>
                    <th>Avg</th>
                    <th>Price</th>
                    <th>Value</th>
                    <th>P&L</th>
                    <th>P&L %</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for holding in holdings %}
                <tr>
                    <td style="text-align: center; padding: 0.5rem;">
                        {% if holding.stock.logo_url %}
                            <img src="{{ holding.stock.logo_url }}" 
                                 alt="{{ holding.stock.symbol }} logo" 
                                 style="width: 32px; height: 32px; border-radius: 4px; object-fit: contain;"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                            <div style="display: none; width: 32px; height: 32px; background-color: #f8f9fa; border-radius: 4px; 
                                        line-height: 32px; text-align: center; font-size: 12px; color: #6c757d; font-weight: bold;">
                                {{ holding.stock.symbol|slice:":2" }}
                            </div>
                        {% else %}
                            <div style="width: 32px; height: 32px; background-color: #f8f9fa; border-radius: 4px; 
                                        line-height: 32px; text-align: center; font-size: 12px; color: #6c757d; font-weight: bold;">
                                {{ holding.stock.symbol|slice:":2" }}
                            </div>
                        {% endif %}
                    </td>
                    <td>
                        <strong><a href="{% url 'soulstrader:stock_detail' holding.stock.symbol %}" style="color: #667eea; text-decoration: none;">{{ holding.stock.symbol }}</a></strong><br>
                        <small>{{ holding.stock.name }}</small><br>
                        <small style="color: #6c757d;">{{ holding.stock.sector }}</small>
                    </td>
                    <td style="text-align: center;">
                        {% if holding.stock.fmp_grade %}
                            <span style="
                                padding: 2px 6px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;
                                {% if holding.stock.fmp_grade|slice:':1' == 'A' %}background-color: #d4edda; color: #155724;
                                {% elif holding.stock.fmp_grade|slice:':1' == 'B' %}background-color: #fff3cd; color: #856404;
                                {% elif holding.stock.fmp_grade|slice:':1' == 'C' %}background-color: #f8d7da; color: #721c24;
                                {% elif holding.stock.fmp_grade|slice:':1' == 'D' %}background-color: #f5c6cb; color: #721c24;
                                {% else %}background-color: #f8f9fa; color: #6c757d;
                                {% endif %}
                            ">{{ holding.stock.fmp_grade }}</span>
                        {% else %}
                            <span style="color: #6c757d; font-size: 0.8rem;">N/A</span>
                        {% endif %}
                    </td>
                    <td>{{ holding.quantity }}</td>
                    <td>${{ holding.average_price|floatformat:2 }}</td>
                    <td>${{ holding.stock.current_price|floatformat:2|default:"N/A" }}</td>
                    <td>${{ holding.current_value|floatformat:2 }}</td>
                    <td class="{% if holding.unrealized_pnl >= 0 %}positive{% else %}negative{% endif %}">
                        ${{ holding.unrealized_pnl|floatformat:2 }}
                    </td>
                    <td class="{% if holding.unrealized_pnl_percent >= 0 %}positive{% else %}negative{% endif %}">
                        {{ holding.unrealized_pnl_percent|floatformat:2 }}%
                    </td>
                    <td>
                        <button class="btn" 
                                style="padding: 0.5rem 1rem; font-size: 0.9rem; background-color: #dc3545; border: none; cursor: pointer; color: white;"
                                data-symbol="{{ holding.stock.symbol }}"
                                data-quantity="{{ holding.quantity }}"
                                data-price="{{ holding.stock.current_price }}"
                                data-name="{{ holding.stock.name }}"
                                onclick="openSellModal('{{ holding.stock.symbol }}', {{ holding.quantity }}, {{ holding.stock.current_price }}, '{{ holding.stock.name }}')">
                            Sell Now
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Holdings Summary -->
    <div style="margin-top: 2rem; padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
        <h3 style="margin-bottom: 1rem; color: #333;">Holdings Summary</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
                <strong>Total Holdings Value:</strong><br>
                <span style="font-size: 1.2rem; color: #667eea;">${{ total_current_value|floatformat:2 }}</span>
            </div>
            <div>
                <strong>Total Unrealized P&L:</strong><br>
                <span style="font-size: 1.2rem; {% if total_unrealized_pnl >= 0 %}color: #28a745;{% else %}color: #dc3545;{% endif %}">
                    ${{ total_unrealized_pnl|floatformat:2 }}
                </span>
            </div>
            <div>
                <strong>Cash Percentage:</strong><br>
                <span style="font-size: 1.2rem; color: #667eea;">
                    {% widthratio portfolio.current_capital portfolio.total_value 100 %}%
                </span>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="card">
    <h2 style="margin-bottom: 1.5rem; color: #333;">Your Holdings</h2>
    <div style="text-align: center; padding: 3rem; color: #6c757d;">
        <h3 style="margin-bottom: 1rem;">No Holdings Yet</h3>
        <p style="margin-bottom: 2rem;">You don't have any stock holdings in your portfolio yet.</p>
        <p style="margin-bottom: 2rem;">Check out our AI recommendations to start building your portfolio!</p>
        <a href="{% url 'soulstrader:recommendations' %}" class="btn">View AI Recommendations</a>
    </div>
</div>
{% endif %}

<!-- Recent Trades -->
{% if recent_trades %}
<div class="card">
    <h2 style="margin-bottom: 1.5rem; color: #333;">📊 Recent Trades</h2>
    
    {% for trade in recent_trades %}
    <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #f8f9fa;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
            <div>
                <h3 style="margin: 0; color: #333;">
                    <a href="{% url 'soulstrader:stock_detail' trade.stock.symbol %}" style="color: #667eea; text-decoration: none;">
                        {{ trade.stock.symbol }} - {{ trade.stock.name }}
                    </a>
                </h3>
                <p style="margin: 0.5rem 0 0 0; color: #6c757d; font-size: 0.9rem;">
                    {{ trade.get_source_display_with_icon }} • {{ trade.created_at|date:"M d, Y H:i" }}
                </p>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">
                    <span class="{% if trade.trade_type == 'BUY' %}positive{% else %}negative{% endif %}">
                        {{ trade.get_trade_type_display }} {{ trade.quantity }} shares
                    </span>
                </div>
                <div style="font-size: 0.9rem; color: #6c757d;">
                    <span style="
                        {% if trade.status == 'FILLED' %}color: #28a745; font-weight: bold;
                        {% elif trade.status == 'CANCELLED' or trade.status == 'REJECTED' %}color: #dc3545; font-weight: bold;
                        {% elif trade.status == 'PENDING' %}color: #ffc107; font-weight: bold;
                        {% elif trade.status == 'PARTIALLY_FILLED' %}color: #17a2b8; font-weight: bold;
                        {% else %}color: #6c757d; font-weight: bold;
                        {% endif %}
                    ">
                        {{ trade.get_status_display }}
                    </span>
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <div>
                <strong>Price:</strong><br>
                <span style="color: #28a745;">
                    {% if trade.average_fill_price %}
                        ${{ trade.average_fill_price|floatformat:2 }}
                    {% elif trade.price %}
                        ${{ trade.price|floatformat:2 }}
                    {% else %}
                        Market
                    {% endif %}
                </span>
            </div>
            <div>
                <strong>Total Amount:</strong><br>
                <span style="color: #667eea;">
                    {% if trade.total_amount %}
                        ${{ trade.total_amount|floatformat:2 }}
                    {% else %}
                        Pending
                    {% endif %}
                </span>
            </div>
            {% if trade.commission %}
            <div>
                <strong>Commission:</strong><br>
                <span style="color: #dc3545;">${{ trade.commission|floatformat:2 }}</span>
            </div>
            {% endif %}
            {% if trade.source_reference %}
            <div>
                <strong>Source:</strong><br>
                <span style="color: #6c757d; font-size: 0.9rem;">{{ trade.source_reference }}</span>
            </div>
            {% endif %}
        </div>
        
        {% if trade.notes %}
        <div style="margin-top: 1rem; padding: 1rem; background-color: #fff; border-radius: 4px; border-left: 4px solid #667eea;">
            <strong>Explanation:</strong><br>
            <span style="color: #495057; font-size: 0.9rem; line-height: 1.4;">{{ trade.notes }}</span>
        </div>
        {% endif %}
        
        {% if trade.rejection_reason %}
        <div style="margin-top: 1rem; padding: 1rem; background-color: #f8d7da; border-radius: 4px; border-left: 4px solid #dc3545;">
            <strong>Rejection Reason:</strong><br>
            <span style="color: #721c24; font-size: 0.9rem;">{{ trade.rejection_reason }}</span>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Portfolio Actions -->
<div class="card">
    <h2 style="margin-bottom: 1.5rem; color: #333;">Portfolio Actions</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{% url 'soulstrader:recommendations' %}" class="btn">View AI Recommendations</a>
        <a href="{% url 'soulstrader:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
        <button class="btn" style="background-color: #17a2b8;">Rebalance Portfolio</button>
        <button class="btn" style="background-color: #6f42c1;">Export Portfolio</button>
    </div>
</div>

<!-- Portfolio Settings -->
<div class="card">
    <h2 style="margin-bottom: 1.5rem; color: #333;">Portfolio Settings</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
        <div>
            <h4 style="color: #667eea; margin-bottom: 0.5rem;">Auto Rebalancing</h4>
            <p style="color: #6c757d; font-size: 0.9rem;">
                {% if portfolio.auto_rebalance %}
                    ✅ Enabled ({{ portfolio.get_rebalance_frequency_display }})
                {% else %}
                    ❌ Disabled
                {% endif %}
            </p>
        </div>
        <div>
            <h4 style="color: #667eea; margin-bottom: 0.5rem;">Portfolio Status</h4>
            <p style="color: #6c757d; font-size: 0.9rem;">
                {% if portfolio.is_active %}
                    ✅ Active
                {% else %}
                    ❌ Inactive
                {% endif %}
            </p>
        </div>
        <div>
            <h4 style="color: #667eea; margin-bottom: 0.5rem;">Created</h4>
            <p style="color: #6c757d; font-size: 0.9rem;">
                {{ portfolio.created_at|date:"M d, Y" }}
            </p>
        </div>
    </div>
</div>

<!-- Sell Modal -->
<div id="sellModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 10% auto; padding: 2rem; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h2 style="margin-bottom: 1.5rem; color: #333;">Sell Shares</h2>
        
        <form id="sellForm" method="post" action="{% url 'soulstrader:sell_shares' %}">
            {% csrf_token %}
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Stock:</label>
                <div style="padding: 0.5rem; background-color: #f8f9fa; border-radius: 4px;">
                    <span id="sellStockName"></span> (<span id="sellStockSymbol"></span>)
                </div>
                <input type="hidden" id="sellSymbol" name="symbol" />
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Current Price:</label>
                <div style="padding: 0.5rem; background-color: #f8f9fa; border-radius: 4px;">
                    $<span id="sellCurrentPrice"></span>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label for="sellQuantity" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Shares to Sell:</label>
                <input type="number" 
                       id="sellQuantity" 
                       name="quantity" 
                       min="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                       oninput="updateSellEstimate()" />
                <small style="color: #6c757d;">You own <span id="maxShares"></span> shares</small>
            </div>
            
            <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #e8f4fd; border-radius: 4px;">
                <strong>Estimated Proceeds:</strong>
                <div style="font-size: 1.2rem; color: #667eea; font-weight: bold;">
                    $<span id="estimatedProceeds">0.00</span>
                </div>
                <small style="color: #6c757d;">Estimated after commission</small>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" 
                        onclick="closeSellModal()" 
                        style="padding: 0.5rem 1rem; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Cancel
                </button>
                <button type="submit" 
                        style="padding: 0.5rem 1rem; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Sell Shares
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentPrice = 0;
const COMMISSION_RATE = 0.001; // 0.1%
const MIN_COMMISSION = 1.00;   // Minimum $1

function openSellModal(symbol, maxQuantity, price, name) {
    document.getElementById('sellStockSymbol').textContent = symbol;
    document.getElementById('sellStockName').textContent = name;
    document.getElementById('sellCurrentPrice').textContent = price.toFixed(2);
    document.getElementById('sellSymbol').value = symbol;
    document.getElementById('sellQuantity').value = maxQuantity;
    document.getElementById('sellQuantity').max = maxQuantity;
    document.getElementById('maxShares').textContent = maxQuantity;
    
    currentPrice = price;
    updateSellEstimate();
    
    document.getElementById('sellModal').style.display = 'block';
    document.getElementById('sellQuantity').focus();
}

function closeSellModal() {
    document.getElementById('sellModal').style.display = 'none';
}

function updateSellEstimate() {
    const quantity = parseInt(document.getElementById('sellQuantity').value) || 0;
    const maxShares = parseInt(document.getElementById('maxShares').textContent);
    
    // Validate quantity
    if (quantity > maxShares) {
        document.getElementById('sellQuantity').value = maxShares;
        quantity = maxShares;
    }
    
    if (quantity > 0) {
        const grossProceeds = quantity * currentPrice;
        const commission = Math.max(grossProceeds * COMMISSION_RATE, MIN_COMMISSION);
        const netProceeds = grossProceeds - commission;
        
        document.getElementById('estimatedProceeds').textContent = netProceeds.toFixed(2);
    } else {
        document.getElementById('estimatedProceeds').textContent = '0.00';
    }
}

// Close modal when clicking outside
document.getElementById('sellModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeSellModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeSellModal();
    }
});
</script>

{% endblock %}
