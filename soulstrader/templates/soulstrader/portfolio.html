{% extends 'soulstrader/base.html' %}

{% block title %}Portfolio - SOULTRADER{% endblock %}

{% block content %}
<div class="card">
    <h1 style="color: #667eea; margin-bottom: 1rem;">Portfolio Overview</h1>
    <p style="color: #6c757d; margin-bottom: 2rem;">Detailed view of your holdings and portfolio performance.</p>
    
    <!-- Portfolio Summary -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">${{ portfolio.total_value|floatformat:2 }}</div>
            <div class="stat-label">Total Portfolio Value</div>
        </div>
        <div class="stat-card">
            <div class="stat-number {% if portfolio.total_return >= 0 %}positive{% else %}negative{% endif %}">
                {{ portfolio.total_return|floatformat:2 }}%
            </div>
            <div class="stat-label">Total Return</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${{ portfolio.current_capital|floatformat:2 }}</div>
            <div class="stat-label">Available Cash</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${{ total_invested|floatformat:2 }}</div>
            <div class="stat-label">Total Invested</div>
        </div>
    </div>
</div>

<!-- Holdings Table -->
{% if holdings %}
<div class="card">
    <h2 style="margin-bottom: 1.5rem; color: #333;">Your Holdings</h2>
    <div class="table">
        <table>
            <thead>
                <tr>
                    <th>Stock</th>
                    <th>Quantity</th>
                    <th>Avg Price</th>
                    <th>Current Price</th>
                    <th>Current Value</th>
                    <th>Unrealized P&L</th>
                    <th>P&L %</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for holding in holdings %}
                <tr>
                    <td>
                        <strong><a href="{% url 'soulstrader:stock_detail' holding.stock.symbol %}" style="color: #667eea; text-decoration: none;">{{ holding.stock.symbol }}</a></strong><br>
                        <small>{{ holding.stock.name }}</small><br>
                        <small style="color: #6c757d;">{{ holding.stock.sector }}</small>
                    </td>
                    <td>{{ holding.quantity }}</td>
                    <td>${{ holding.average_price|floatformat:2 }}</td>
                    <td>${{ holding.stock.current_price|floatformat:2|default:"N/A" }}</td>
                    <td>${{ holding.current_value|floatformat:2 }}</td>
                    <td class="{% if holding.unrealized_pnl >= 0 %}positive{% else %}negative{% endif %}">
                        ${{ holding.unrealized_pnl|floatformat:2 }}
                    </td>
                    <td class="{% if holding.unrealized_pnl_percent >= 0 %}positive{% else %}negative{% endif %}">
                        {{ holding.unrealized_pnl_percent|floatformat:2 }}%
                    </td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin: 0.1rem;">Sell</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Holdings Summary -->
    <div style="margin-top: 2rem; padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
        <h3 style="margin-bottom: 1rem; color: #333;">Holdings Summary</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
                <strong>Total Holdings Value:</strong><br>
                <span style="font-size: 1.2rem; color: #667eea;">${{ total_current_value|floatformat:2 }}</span>
            </div>
            <div>
                <strong>Total Unrealized P&L:</strong><br>
                <span style="font-size: 1.2rem; {% if total_unrealized_pnl >= 0 %}color: #28a745;{% else %}color: #dc3545;{% endif %}">
                    ${{ total_unrealized_pnl|floatformat:2 }}
                </span>
            </div>
            <div>
                <strong>Cash Percentage:</strong><br>
                <span style="font-size: 1.2rem; color: #667eea;">
                    {% widthratio portfolio.current_capital portfolio.total_value 100 %}%
                </span>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="card">
    <h2 style="margin-bottom: 1.5rem; color: #333;">Your Holdings</h2>
    <div style="text-align: center; padding: 3rem; color: #6c757d;">
        <h3 style="margin-bottom: 1rem;">No Holdings Yet</h3>
        <p style="margin-bottom: 2rem;">You don't have any stock holdings in your portfolio yet.</p>
        <p style="margin-bottom: 2rem;">Check out our AI recommendations to start building your portfolio!</p>
        <a href="{% url 'soulstrader:recommendations' %}" class="btn">View AI Recommendations</a>
    </div>
</div>
{% endif %}

<!-- Recent Trades -->
{% if recent_trades %}
<div class="card">
    <h2 style="margin-bottom: 1.5rem; color: #333;">Recent Trades</h2>
    <div class="table">
        <table>
            <thead>
                <tr>
                    <th>Stock</th>
                    <th>Type</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Total Amount</th>
                    <th>Notes</th>
                    <th>Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for trade in recent_trades %}
                <tr>
                    <td>
                        <strong>{{ trade.stock.symbol }}</strong><br>
                        <small>{{ trade.stock.name }}</small>
                    </td>
                    <td>
                        <span class="{% if trade.trade_type == 'BUY' %}positive{% else %}negative{% endif %}">
                            {{ trade.get_trade_type_display }}
                        </span>
                    </td>
                    <td>{{ trade.quantity }}</td>
                    <td>
                        {% if trade.average_fill_price %}
                            ${{ trade.average_fill_price|floatformat:2 }}
                        {% elif trade.price %}
                            ${{ trade.price|floatformat:2 }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if trade.total_amount %}
                            ${{ trade.total_amount|floatformat:2 }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if trade.notes %}
                            <small>{{ trade.notes|truncatechars:30 }}</small>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ trade.created_at|date:"M d, Y H:i" }}</td>
                    <td>
                        <span style="
                            {% if trade.status == 'FILLED' %}color: #28a745; font-weight: bold;
                            {% elif trade.status == 'CANCELLED' or trade.status == 'REJECTED' %}color: #dc3545; font-weight: bold;
                            {% elif trade.status == 'PENDING' %}color: #ffc107; font-weight: bold;
                            {% elif trade.status == 'PARTIALLY_FILLED' %}color: #17a2b8; font-weight: bold;
                            {% else %}color: #6c757d; font-weight: bold;
                            {% endif %}
                        ">
                            {{ trade.get_status_display }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Portfolio Actions -->
<div class="card">
    <h2 style="margin-bottom: 1.5rem; color: #333;">Portfolio Actions</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{% url 'soulstrader:recommendations' %}" class="btn">View AI Recommendations</a>
        <a href="{% url 'soulstrader:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
        <button class="btn" style="background-color: #17a2b8;">Rebalance Portfolio</button>
        <button class="btn" style="background-color: #6f42c1;">Export Portfolio</button>
    </div>
</div>

<!-- Portfolio Settings -->
<div class="card">
    <h2 style="margin-bottom: 1.5rem; color: #333;">Portfolio Settings</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
        <div>
            <h4 style="color: #667eea; margin-bottom: 0.5rem;">Auto Rebalancing</h4>
            <p style="color: #6c757d; font-size: 0.9rem;">
                {% if portfolio.auto_rebalance %}
                    ✅ Enabled ({{ portfolio.get_rebalance_frequency_display }})
                {% else %}
                    ❌ Disabled
                {% endif %}
            </p>
        </div>
        <div>
            <h4 style="color: #667eea; margin-bottom: 0.5rem;">Portfolio Status</h4>
            <p style="color: #6c757d; font-size: 0.9rem;">
                {% if portfolio.is_active %}
                    ✅ Active
                {% else %}
                    ❌ Inactive
                {% endif %}
            </p>
        </div>
        <div>
            <h4 style="color: #667eea; margin-bottom: 0.5rem;">Created</h4>
            <p style="color: #6c757d; font-size: 0.9rem;">
                {{ portfolio.created_at|date:"M d, Y" }}
            </p>
        </div>
    </div>
</div>
{% endblock %}
