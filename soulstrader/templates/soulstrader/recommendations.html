{% extends 'soulstrader/base.html' %}

{% block title %}AI Recommendations - SOULTRADER{% endblock %}

{% block content %}
<style>
.tab-button {
    background-color: #f8f9fa;
    border: none;
    padding: 1rem 2rem;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    font-weight: 500;
    font-size: 1.1rem;
    color: #6c757d;
    transition: all 0.3s ease;
}

.tab-button:hover {
    background-color: #e9ecef;
    color: #495057;
}

.tab-button.active {
    background-color: white;
    color: #667eea;
    border-bottom-color: #667eea;
    font-weight: 600;
}

.tab-content {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
<div class="card">
    <h1 style="color: #667eea; margin-bottom: 1rem;">üìà AI Recommendations</h1>
    <p style="color: #6c757d; margin-bottom: 2rem;">Personalized stock recommendations based on your risk profile and market analysis.</p>
    
    <!-- Filter Options -->
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; align-items: center;">
        <div>
            <label for="type-filter" style="font-weight: 500; margin-right: 0.5rem;">Filter by Type:</label>
            <select id="type-filter" onchange="filterRecommendations()" style="padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;">
                <option value="">All Types</option>
                {% for value, label in recommendation_types %}
                    <option value="{{ value }}" {% if request.GET.type == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="confidence-filter" style="font-weight: 500; margin-right: 0.5rem;">Filter by Confidence:</label>
            <select id="confidence-filter" onchange="filterRecommendations()" style="padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;">
                <option value="">All Levels</option>
                {% for value, label in confidence_levels %}
                    <option value="{{ value }}" {% if request.GET.confidence == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <a href="{% url 'soulstrader:recommendations' %}" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Clear Filters</a>
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="card">
    <div style="border-bottom: 1px solid #e9ecef; margin-bottom: 0;">
        <div style="display: flex; gap: 0;">
            <button class="tab-button active" onclick="showTab('all-recommendations')" id="tab-all-recommendations">
                üìà All Recommendations
            </button>
            <button class="tab-button" onclick="showTab('smart-analysis')" id="tab-smart-analysis">
                üß† Smart Analysis
            </button>
        </div>
    </div>
</div>

<!-- Tab Content: All Recommendations -->
<div id="all-recommendations-content" class="tab-content">
{% if all_recommendations %}
<div class="card">
    <h2 style="margin-bottom: 1.5rem; color: #333;">
        AI Recommendations ({{ total_count }} found)
        {% if advisor_count > 0 %}<span style="color: #28a745;">‚Ä¢ {{ advisor_count }} from AI Advisors</span>{% endif %}
        {% if legacy_count > 0 %}<span style="color: #17a2b8;">‚Ä¢ {{ legacy_count }} Personal</span>{% endif %}
    </h2>
    
    {% for rec in all_recommendations %}
    <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #f8f9fa;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
            <div>
                <h3 style="margin: 0; color: #333;">
                    <a href="{% url 'soulstrader:stock_detail' rec.stock.symbol %}" style="color: #667eea; text-decoration: none;">
                        {{ rec.stock.symbol }} - {{ rec.stock.name }}
                    </a>
                </h3>
                <p style="margin: 0.5rem 0 0 0; color: #6c757d; font-size: 0.9rem;">
                    {{ rec.stock.sector }} ‚Ä¢ {{ rec.stock.market_cap_category }}
                </p>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">
                    <span class="{% if rec.recommendation_type == 'BUY' or rec.recommendation_type == 'STRONG_BUY' %}positive{% elif rec.recommendation_type == 'SELL' or rec.recommendation_type == 'STRONG_SELL' %}negative{% endif %}">
                        {{ rec.recommendation_type|capfirst }}
                    </span>
                </div>
                <div style="color: #6c757d; font-size: 0.9rem;">
                    {{ rec.confidence_level|capfirst }} Confidence ({{ rec.confidence_score }})
                </div>
                <div style="color: #28a745; font-size: 0.8rem; font-weight: 500;">
                    by {{ rec.advisor_name }}
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <div>
                <strong>Current Price:</strong><br>
                <span style="color: #667eea; font-size: 1.1rem;">${{ rec.stock.current_price|floatformat:2|default:"N/A" }}</span>
            </div>
            <div>
                <strong>Target Price:</strong><br>
                <span style="color: #28a745; font-size: 1.1rem;">${{ rec.recommendation.target_price|floatformat:2|default:"N/A" }}</span>
            </div>
            <div>
                <strong>Stop Loss:</strong><br>
                <span style="color: #dc3545; font-size: 1.1rem;">${{ rec.recommendation.stop_loss|floatformat:2|default:"N/A" }}</span>
            </div>
            <div>
                <strong>Confidence Score:</strong><br>
                <span style="color: #667eea; font-size: 1.1rem;">{{ rec.confidence_score|floatformat:2 }}</span>
            </div>
        </div>
        
        <div style="margin-bottom: 1rem;">
            <strong>AI Reasoning:</strong>
            <p style="margin: 0.5rem 0; color: #555; line-height: 1.5;">{{ rec.reasoning }}</p>
        </div>
        
        <div style="display: flex; gap: 1rem; align-items: center; justify-content: space-between;">
            <div style="font-size: 0.9rem; color: #6c757d;">
                <strong>Advisor:</strong> {{ rec.advisor_name }} ‚Ä¢ 
                <strong>Created:</strong> {{ rec.created_at|date:"M d, Y H:i" }}
                {% if rec.recommendation.expires_at %}
                    ‚Ä¢ <strong>Expires:</strong> {{ rec.recommendation.expires_at|date:"M d, Y" }}
                {% endif %}
            </div>
            <div style="display: flex; gap: 0.5rem;">
                {% if rec.recommendation_type == 'BUY' or rec.recommendation_type == 'STRONG_BUY' %}
                    <button class="btn" 
                            style="padding: 0.5rem 1rem; font-size: 0.9rem; background-color: #28a745; border: none; cursor: pointer;"
                            onclick="openBuyModal('{{ rec.stock.symbol }}', '{{ rec.stock.name }}', {{ rec.stock.current_price }}, {{ rec.recommendation.target_price|default:rec.stock.current_price }})">
                        Buy Now
                    </button>
                {% elif rec.recommendation_type == 'SELL' or rec.recommendation_type == 'STRONG_SELL' %}
                    <button class="btn" 
                            style="padding: 0.5rem 1rem; font-size: 0.9rem; background-color: #dc3545; border: none; cursor: pointer;"
                            onclick="openSellFromRecommendationsModal('{{ rec.stock.symbol }}', '{{ rec.stock.name }}', {{ rec.stock.current_price }}, {{ rec.recommendation.target_price|default:rec.stock.current_price }})">
                        Sell Now
                    </button>
                {% else %}
                    <a href="{% url 'soulstrader:stock_detail' rec.stock.symbol %}" class="btn" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        View Details
                    </a>
                {% endif %}
                <a href="{% url 'soulstrader:stock_detail' rec.stock.symbol %}" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                    Stock Details
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card">
    <h2 style="margin-bottom: 1.5rem; color: #333;">No Recommendations Found</h2>
    <div style="text-align: center; padding: 3rem; color: #6c757d;">
        <h3 style="margin-bottom: 1rem;">No AI recommendations available</h3>
        <p style="margin-bottom: 2rem;">This could be because:</p>
        <ul style="text-align: left; max-width: 400px; margin: 0 auto 2rem auto;">
            <li>No recommendations match your current filters</li>
            <li>AI analysis is still processing</li>
            <li>Market conditions don't meet our recommendation criteria</li>
        </ul>
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <a href="{% url 'soulstrader:recommendations' %}" class="btn btn-secondary">Clear Filters</a>
            <a href="{% url 'soulstrader:dashboard' %}" class="btn">Back to Dashboard</a>
        </div>
    </div>
</div>
{% endif %}
</div>

<!-- Tab Content: Smart Analysis -->
<div id="smart-analysis-content" class="tab-content" style="display: none;">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #333; margin: 0;">üß† Portfolio-Aware Smart Analysis</h2>
            <button class="btn" style="background-color: #667eea;" onclick="generateSmartAnalysis()">
                Generate Analysis
            </button>
        </div>
        
        <div id="smart-analysis-results" style="display: none;">
            <!-- Smart analysis results will be loaded here -->
        </div>
        
        <div id="smart-analysis-placeholder" style="text-align: center; padding: 3rem; color: #6c757d;">
            <h3 style="margin-bottom: 1rem;">Portfolio-Aware AI Analysis</h3>
            <p style="margin-bottom: 2rem;">
                Get intelligent, personalized recommendations based on your current holdings:
            </p>
            <ul style="text-align: left; max-width: 500px; margin: 0 auto 2rem auto; color: #555;">
                <li>‚úÖ <strong>Portfolio Context</strong> - Only relevant SELL recommendations for stocks you own</li>
                <li>‚úÖ <strong>Consolidated Analysis</strong> - Multiple advisor opinions per stock</li>
                <li>‚úÖ <strong>Cost Basis Awareness</strong> - Factors in your average purchase prices</li>
                <li>‚úÖ <strong>Intelligent Ranking</strong> - Best opportunities prioritized</li>
                <li>‚úÖ <strong>Actionable Insights</strong> - Tailored to your specific portfolio</li>
            </ul>
            <button class="btn" style="background-color: #28a745; font-size: 1.1rem; padding: 0.75rem 2rem;" onclick="generateSmartAnalysis()">
                üß† Generate Smart Analysis
            </button>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <h2 style="margin-bottom: 1.5rem; color: #333;">Quick Actions</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{% url 'soulstrader:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
        <a href="{% url 'soulstrader:portfolio' %}" class="btn">View Portfolio</a>
        <button class="btn" style="background-color: #17a2b8;">Refresh Recommendations</button>
        <button class="btn" style="background-color: #6f42c1;">Export Recommendations</button>
    </div>
</div>

<script>
function filterRecommendations() {
    const typeFilter = document.getElementById('type-filter').value;
    const confidenceFilter = document.getElementById('confidence-filter').value;
    
    let url = '{% url "soulstrader:recommendations" %}';
    const params = new URLSearchParams();
    
    if (typeFilter) params.append('type', typeFilter);
    if (confidenceFilter) params.append('confidence', confidenceFilter);
    
    if (params.toString()) {
        url += '?' + params.toString();
    }
    
    window.location.href = url;
}
</script>

<!-- Buy Modal -->
<div id="buyModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 10% auto; padding: 2rem; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h2 style="margin-bottom: 1.5rem; color: #333;">Buy Shares</h2>
        
        <form id="buyForm" method="post" action="{% url 'soulstrader:buy_from_recommendations' %}">
            {% csrf_token %}
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Stock:</label>
                <div style="padding: 0.5rem; background-color: #f8f9fa; border-radius: 4px;">
                    <span id="buyStockName"></span> (<span id="buyStockSymbol"></span>)
                </div>
                <input type="hidden" id="buySymbol" name="symbol" />
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Current Price:</label>
                <div style="padding: 0.5rem; background-color: #f8f9fa; border-radius: 4px;">
                    $<span id="buyCurrentPrice"></span>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">AI Target Price:</label>
                <div style="padding: 0.5rem; background-color: #e8f4fd; border-radius: 4px; color: #28a745;">
                    $<span id="buyTargetPrice"></span>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label for="buyQuantity" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Shares to Buy:</label>
                <input type="number" 
                       id="buyQuantity" 
                       name="quantity" 
                       min="1" 
                       value="10"
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                       oninput="updateBuyEstimate()" />
                <small style="color: #6c757d;">Available cash: $<span id="availableCash">{{ request.user.portfolio.current_capital|floatformat:2 }}</span></small>
            </div>
            
            <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f8f4fd; border-radius: 4px;">
                <strong>Estimated Cost:</strong>
                <div style="font-size: 1.2rem; color: #667eea; font-weight: bold;">
                    $<span id="estimatedCost">0.00</span>
                </div>
                <small style="color: #6c757d;">Including commission</small>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" 
                        onclick="closeBuyModal()" 
                        style="padding: 0.5rem 1rem; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Cancel
                </button>
                <button type="submit" 
                        style="padding: 0.5rem 1rem; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Buy Shares
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let buyCurrentPrice = 0;
const BUY_COMMISSION_RATE = 0.001; // 0.1%
const BUY_MIN_COMMISSION = 1.00;   // Minimum $1

function openBuyModal(symbol, name, currentPrice, targetPrice) {
    document.getElementById('buyStockSymbol').textContent = symbol;
    document.getElementById('buyStockName').textContent = name;
    document.getElementById('buyCurrentPrice').textContent = currentPrice.toFixed(2);
    document.getElementById('buyTargetPrice').textContent = targetPrice.toFixed(2);
    document.getElementById('buySymbol').value = symbol;
    document.getElementById('buyQuantity').value = 10; // Default to 10 shares
    
    buyCurrentPrice = currentPrice;
    updateBuyEstimate();
    
    document.getElementById('buyModal').style.display = 'block';
    document.getElementById('buyQuantity').focus();
}

function closeBuyModal() {
    document.getElementById('buyModal').style.display = 'none';
}

function updateBuyEstimate() {
    const quantity = parseInt(document.getElementById('buyQuantity').value) || 0;
    
    if (quantity > 0) {
        const grossCost = quantity * buyCurrentPrice;
        const commission = Math.max(grossCost * BUY_COMMISSION_RATE, BUY_MIN_COMMISSION);
        const totalCost = grossCost + commission;
        
        document.getElementById('estimatedCost').textContent = totalCost.toFixed(2);
    } else {
        document.getElementById('estimatedCost').textContent = '0.00';
    }
}

// Close modal when clicking outside
document.getElementById('buyModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeBuyModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeBuyModal();
    }
});

// Tab functionality
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + '-content').style.display = 'block';
    
    // Add active class to selected tab button
    document.getElementById('tab-' + tabName).classList.add('active');
}

// Smart Analysis functionality
function generateSmartAnalysis() {
    const placeholder = document.getElementById('smart-analysis-placeholder');
    const results = document.getElementById('smart-analysis-results');
    
    // Show loading state
    placeholder.innerHTML = `
        <div style="text-align: center; padding: 3rem;">
            <h3 style="color: #667eea;">üß† Analyzing Your Portfolio...</h3>
            <p style="color: #6c757d;">Processing AI recommendations with portfolio context</p>
            <div style="margin: 2rem 0;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
        </div>
    `;
    
    // Make AJAX request to get smart analysis
    fetch('/recommendations/smart-analysis/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            placeholder.style.display = 'none';
            results.innerHTML = data.html;
            results.style.display = 'block';
        } else {
            placeholder.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #dc3545;">
                    <h3>Analysis Failed</h3>
                    <p>${data.error || 'Unknown error occurred'}</p>
                    <button class="btn" onclick="generateSmartAnalysis()">Try Again</button>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        placeholder.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #dc3545;">
                <h3>Connection Error</h3>
                <p>Unable to generate analysis. Please try again.</p>
                <button class="btn" onclick="generateSmartAnalysis()">Try Again</button>
            </div>
        `;
    });
}

// Sell Modal Functions
function openSellFromRecommendationsModal(symbol, name, currentPrice, targetPrice) {
    // First check if user owns the stock
    fetch(`/api/stock-info/${symbol}/`)
        .then(response => response.json())
        .then(data => {
            if (data.user_holding && data.user_holding.quantity > 0) {
                // User owns the stock, open sell modal
                document.getElementById('sellRecStockSymbol').textContent = symbol;
                document.getElementById('sellRecStockName').textContent = name;
                document.getElementById('sellRecCurrentPrice').textContent = currentPrice.toFixed(2);
                document.getElementById('sellRecTargetPrice').textContent = targetPrice.toFixed(2);
                document.getElementById('sellRecSymbol').value = symbol;
                document.getElementById('sellRecQuantity').value = data.user_holding.quantity;
                document.getElementById('sellRecQuantity').max = data.user_holding.quantity;
                document.getElementById('sellRecMaxShares').textContent = data.user_holding.quantity;
                
                sellRecCurrentPrice = currentPrice;
                updateSellRecEstimate();
                
                document.getElementById('sellRecModal').style.display = 'block';
                document.getElementById('sellRecQuantity').focus();
            } else {
                // User doesn't own the stock
                alert(`You don't own any ${symbol} shares to sell.`);
            }
        })
        .catch(error => {
            console.error('Error checking holdings:', error);
            alert('Error checking your holdings. Please try again.');
        });
}

function closeSellRecModal() {
    document.getElementById('sellRecModal').style.display = 'none';
}

let sellRecCurrentPrice = 0;

function updateSellRecEstimate() {
    const quantity = parseInt(document.getElementById('sellRecQuantity').value) || 0;
    const maxShares = parseInt(document.getElementById('sellRecMaxShares').textContent);
    
    // Validate quantity
    if (quantity > maxShares) {
        document.getElementById('sellRecQuantity').value = maxShares;
        quantity = maxShares;
    }
    
    if (quantity > 0) {
        const grossProceeds = quantity * sellRecCurrentPrice;
        const commission = Math.max(grossProceeds * BUY_COMMISSION_RATE, BUY_MIN_COMMISSION);
        const netProceeds = grossProceeds - commission;
        
        document.getElementById('sellRecEstimatedProceeds').textContent = netProceeds.toFixed(2);
    } else {
        document.getElementById('sellRecEstimatedProceeds').textContent = '0.00';
    }
}

// Close sell modal when clicking outside
document.getElementById('sellRecModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeSellRecModal();
    }
});

// Advisor Details Modal Functions
function showAdvisorDetails(symbol) {
    const modal = document.getElementById('advisorDetailsModal');
    const content = document.getElementById('advisorDetailsContent');
    
    // Show loading state
    content.innerHTML = `
        <div style="text-align: center; padding: 3rem;">
            <h3 style="color: #667eea;">üîç Loading Advisor Details...</h3>
            <div style="margin: 2rem 0;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
        </div>
    `;
    
    modal.style.display = 'block';
    
    // Fetch advisor details
    fetch(`/recommendations/advisor-details/${symbol}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                content.innerHTML = data.html;
            } else {
                content.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #dc3545;">
                        <h3>Error Loading Details</h3>
                        <p>${data.error || 'Unknown error occurred'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            content.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #dc3545;">
                    <h3>Connection Error</h3>
                    <p>Unable to load advisor details. Please try again.</p>
                </div>
            `;
        });
}

function closeAdvisorDetailsModal() {
    document.getElementById('advisorDetailsModal').style.display = 'none';
}

// Close details modal when clicking outside
document.getElementById('advisorDetailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAdvisorDetailsModal();
    }
});
</script>

<!-- Sell Modal -->
<div id="sellRecModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 10% auto; padding: 2rem; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h2 style="margin-bottom: 1.5rem; color: #333;">Sell Shares</h2>
        
        <form id="sellRecForm" method="post" action="{% url 'soulstrader:sell_from_recommendations' %}">
            {% csrf_token %}
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Stock:</label>
                <div style="padding: 0.5rem; background-color: #f8f9fa; border-radius: 4px;">
                    <span id="sellRecStockName"></span> (<span id="sellRecStockSymbol"></span>)
                </div>
                <input type="hidden" id="sellRecSymbol" name="symbol" />
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Current Price:</label>
                <div style="padding: 0.5rem; background-color: #f8f9fa; border-radius: 4px;">
                    $<span id="sellRecCurrentPrice"></span>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">AI Target Price:</label>
                <div style="padding: 0.5rem; background-color: #fdf2f2; border-radius: 4px; color: #dc3545;">
                    $<span id="sellRecTargetPrice"></span>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label for="sellRecQuantity" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Shares to Sell:</label>
                <input type="number" 
                       id="sellRecQuantity" 
                       name="quantity" 
                       min="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                       oninput="updateSellRecEstimate()" />
                <small style="color: #6c757d;">You own <span id="sellRecMaxShares"></span> shares</small>
            </div>
            
            <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f8f4fd; border-radius: 4px;">
                <strong>Estimated Proceeds:</strong>
                <div style="font-size: 1.2rem; color: #667eea; font-weight: bold;">
                    $<span id="sellRecEstimatedProceeds">0.00</span>
                </div>
                <small style="color: #6c757d;">Net after commission</small>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" 
                        onclick="closeSellRecModal()" 
                        style="padding: 0.5rem 1rem; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Cancel
                </button>
                <button type="submit" 
                        style="padding: 0.5rem 1rem; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Sell Shares
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Advisor Details Modal -->
<div id="advisorDetailsModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 5% auto; padding: 2rem; width: 90%; max-width: 800px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #333; margin: 0;">üîç Advisor Analysis Details</h2>
            <button onclick="closeAdvisorDetailsModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;">&times;</button>
        </div>
        
        <div id="advisorDetailsContent">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

{% endblock %}
